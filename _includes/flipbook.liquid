<div class="project-file-viewer">
  <div class="flipbook-wrapper">
    <button class="side-nav-btn prev" id="sidePrev" title="Previous Page">
      <i class="fa-solid fa-chevron-left"></i>
    </button>

    <div class="flipbook-container">
      <div id="flipbook" class="flipbook">
        <!-- Pages will be generated here -->
        {% assign image_base = "assets/img/projects/" | append: include.project_folder %}
        {% for i in (1..include.image_count) %}
          <div class="page">
            <div class="page-content">
              {% capture img_name %}{{ include.project_folder }} - {{ i }}.jpg{% endcapture %}
              {% capture img_path %}{{ image_base }}/{{ img_name }}{% endcapture %}
              <img src="{{ img_path | relative_url | replace: ' ', '%20' }}" alt="Page {{ i }}">
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <button class="side-nav-btn next" id="sideNext" title="Next Page">
      <i class="fa-solid fa-chevron-right"></i>
    </button>
  </div>

  <div class="flipbook-controls">
    <button id="prevPage">Prev</button>
    <span class="page-num"><span id="currentPage">1</span> / {{ include.image_count }}</span>
    <button id="nextPage">Next</button>
  </div>
</div>

<script>
  window.addEventListener('load', function() {
    const flipbookElement = document.getElementById("flipbook");
    if (!flipbookElement) return;

    // Check if St is defined (library loaded)
    if (typeof St === 'undefined' || !St.PageFlip) {
      console.error("PageFlip library (St.PageFlip) not loaded.");
      return;
    }

    const pageFlip = new St.PageFlip(
      flipbookElement,
      {
        width: 700, // Increased base page width
        height: 990, // Increased base page height (700 * 1.414)
        size: "stretch",
        minWidth: 315,
        maxWidth: 1400, // Increased max width
        minHeight: 445,
        maxHeight: 2000, // Adjusted max height
        maxShadowOpacity: 0.2,
        showCover: false,
        mobileScrollSupport: false,
        startPage: 1,
        drawShadow: true,
        flippingTime: 1000,
        usePortrait: false,
        startVelocity: 10
      }
    );

    // load pages from existing HTML elements
    pageFlip.loadFromHTML(document.querySelectorAll(".page"));

    const sidePrev = document.getElementById("sidePrev");
    const sideNext = document.getElementById("sideNext");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");
    const currentPageSpan = document.getElementById("currentPage");

    function updateNavButtons() {
      const index = pageFlip.getCurrentPageIndex();
      const count = pageFlip.getPageCount();
      
      // Update text indicator
      currentPageSpan.innerText = index + 1;

      // Disable/Enable side buttons
      if (index <= 0) {
        sidePrev.classList.add("disabled");
        prevBtn.disabled = true;
      } else {
        sidePrev.classList.remove("disabled");
        prevBtn.disabled = false;
      }

      if (index >= count - 2) { // In 2-page mode, last index is count-2
        sideNext.classList.add("disabled");
        nextBtn.disabled = true;
      } else {
        sideNext.classList.remove("disabled");
        nextBtn.disabled = false;
      }
    }

    // Update initial page number and buttons
    updateNavButtons();

    sidePrev.addEventListener("click", () => pageFlip.flipPrev());
    sideNext.addEventListener("click", () => pageFlip.flipNext());
    prevBtn.addEventListener("click", () => pageFlip.flipPrev());
    nextBtn.addEventListener("click", () => pageFlip.flipNext());

    pageFlip.on("flip", (e) => {
      updateNavButtons();
    });

    // Keyboard navigation
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        pageFlip.flipPrev();
      } else if (e.key === "ArrowRight") {
        pageFlip.flipNext();
      }
    });
  });
</script>
